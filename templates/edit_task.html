{% extends "base.html" %}

{% block title %}ì •ê¸°ì ê²€ ìˆ˜ì • - ì •ê¸° ì ê²€ ê´€ë¦¬{% endblock %}

{% block content %}
<h1><i class="bi bi-pencil-square me-3"></i>ì •ê¸°ì ê²€ ìˆ˜ì •</h1>

<form method="post" enctype="multipart/form-data" action="/task/{{ task.id }}/edit">
    <!-- Company Selection -->
    <div class="card mb-4" style="border: none; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); border-radius: 16px; padding: 1.5rem;">
        <h5 class="mb-3"><i class="bi bi-building me-2"></i>ê³ ê°ì‚¬ ì •ë³´</h5>
        <div class="mb-3">
            <label for="company_id" class="form-label">ê³ ê°ì‚¬ ì„ íƒ</label>
            <select class="form-select" id="company_id" name="company_id" required>
                {% for comp in companies %}
                    <option value="{{ comp.id }}" {% if comp.id == task.company_id %}selected{% endif %}>
                        {{ comp.name }}{% if comp.sub_name %} / {{ comp.sub_name }}{% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-0">
            <label for="detail_name" class="form-label">ìƒì„¸ ê³ ê°ì‚¬</label>
            <input type="text" class="form-control" id="detail_name" name="detail_name" placeholder="ì˜ˆ: í™ˆí˜ì´ì§€ / ë‹¤ì´ë ‰íŠ¸ / mydata ë“±" value="{{ task.detail_name or '' }}">
        </div>
    </div>

    <!-- Task Type and Signature -->
    <div class="card mb-4" style="border: none; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); border-radius: 16px; padding: 1.5rem;">
        <h5 class="mb-3"><i class="bi bi-clipboard-check me-2"></i>ì ê²€ ì •ë³´</h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">ì ê²€ ìœ í˜•</label>
                <div class="d-flex gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="task_type" id="edit_type_in" value="INHOUSE" {% if task.task_type == 'INHOUSE' %}checked{% endif %}>
                        <label class="form-check-label" for="edit_type_in">
                            ğŸ¢ ì‚¬ë‚´ì ê²€
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="task_type" id="edit_type_out" value="ONSITE" {% if task.task_type == 'ONSITE' %}checked{% endif %}>
                        <label class="form-check-label" for="edit_type_out">
                            ğŸš— ë°©ë¬¸ì ê²€
                        </label>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">ì„œëª… ë°©ë²•</label>
                <div class="d-flex gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="signature_method" id="edit_sig_email" value="EMAIL" {% if task.signature_method == 'EMAIL' %}checked{% endif %}>
                        <label class="form-check-label" for="edit_sig_email">
                            ğŸ“§ ë©”ì¼
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="signature_method" id="edit_sig_visit" value="VISIT" {% if task.signature_method == 'VISIT' %}checked{% endif %}>
                        <label class="form-check-label" for="edit_sig_visit">
                            âœï¸ ë°©ë¬¸
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Information -->
    <div class="card mb-4" style="border: none; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); border-radius: 16px; padding: 1.5rem;">
        <h5 class="mb-3"><i class="bi bi-person-lines-fill me-2"></i>ë‹´ë‹¹ì ì •ë³´</h5>
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">ë‹´ë‹¹ì ì´ë¦„</label>
                <input type="text" class="form-control" name="contact_name" placeholder="í™ê¸¸ë™" value="{{ task.contact_name or '' }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">ì „í™”ë²ˆí˜¸</label>
                <input type="text" class="form-control" name="contact_phone" placeholder="010-1234-5678" value="{{ task.contact_phone or '' }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">ì´ë©”ì¼</label>
                <input type="email" class="form-control" name="contact_email" placeholder="example@company.com" value="{{ task.contact_email or '' }}">
            </div>
        </div>
    </div>

    <!-- Schedule -->
    <div class="card mb-4" style="border: none; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); border-radius: 16px; padding: 1.5rem;">
        <h5 class="mb-3"><i class="bi bi-calendar-range me-2"></i>ìŠ¤ì¼€ì¤„ ì„¤ì •</h5>
        <div class="mb-3">
            <label for="schedule_type" class="form-label">ìŠ¤ì¼€ì¤„ ìœ í˜•</label>
            <select class="form-select" id="schedule_type" name="schedule_type" required onchange="onScheduleTypeChange()">
                <option value="monthly" {% if task.schedule_type == 'monthly' %}selected{% endif %}>ë§¤ì›”</option>
                <option value="quarterly" {% if task.schedule_type == 'quarterly' %}selected{% endif %}>ë¶„ê¸°</option>
                <option value="custom" {% if task.schedule_type not in ['monthly','quarterly'] %}selected{% endif %}>ê¸°íƒ€ (ì‚¬ìš©ì ì§€ì •)</option>
            </select>
            <div id="scheduleDetailHelp" class="form-text"></div>
        </div>
        <div class="mb-0" id="schedule_detail_wrapper" style="{% if task.schedule_type == 'monthly' %}display:none{% endif %};">
            <label for="schedule_detail" class="form-label">ìŠ¤ì¼€ì¤„ ìƒì„¸ (ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì›”)</label>
            <input type="text" class="form-control" id="schedule_detail" name="schedule_detail" placeholder="ì˜ˆ: 1,4,7,10" value="{{ task.schedule_detail or '' }}">
            <div class="form-text">ë¶„ê¸°ë‚˜ ê¸°íƒ€ ìœ í˜•ì¼ ê²½ìš° ìˆ˜í–‰í•  ì›”ë“¤ì„ ì‰¼í‘œë¡œ ì…ë ¥í•˜ì„¸ìš”.</div>
        </div>
    </div>

    <!-- Existing Checklist Items -->
    <div class="card mb-4" style="border: none; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); border-radius: 16px; padding: 1.5rem;">
        <h5 class="mb-3"><i class="bi bi-list-check me-2"></i>ê¸°ì¡´ ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª©</h5>
        {% if items %}
            {% for it in items %}
                <div class="p-3 mb-3" style="background: white; border-radius: 12px; border: 2px solid rgba(102, 126, 234, 0.1);">
                    <input type="hidden" name="existing_item_id" value="{{ it.id }}">
                    <div class="mb-2">
                        <label class="form-label fw-bold">í•­ëª© ì„¤ëª…</label>
                        <input type="text" class="form-control" name="existing_item_description_{{ it.id }}" value="{{ it.description }}">
                    </div>
                    {% if it.attachment %}
                        <div class="mb-2">
                            <label class="form-label fw-bold">ê¸°ì¡´ ì²¨ë¶€íŒŒì¼</label>
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-paperclip text-primary"></i>
                                <a href="/attachments/{{ it.attachment }}" target="_blank" class="text-decoration-none">{{ it.attachment }}</a>
                            </div>
                        </div>
                    {% endif %}
                    <div class="mb-2">
                        <label class="form-label fw-bold">ìƒˆ ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ (ì„ íƒ)</label>
                        <input type="file" class="form-control" name="existing_item_file_{{ it.id }}">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="delete_item_{{ it.id }}" value="1" id="delete_item_{{ it.id }}">
                        <label class="form-check-label text-danger" for="delete_item_{{ it.id }}">
                            <i class="bi bi-trash me-1"></i>ì´ í•­ëª© ì‚­ì œ
                        </label>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle me-2"></i>ì´ ì ê²€ì—ëŠ” ì•„ì§ ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
        {% endif %}
    </div>

    <!-- New Items -->
    <div class="card mb-4" style="border: none; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); border-radius: 16px; padding: 1.5rem;">
        <h5 class="mb-3"><i class="bi bi-plus-circle me-2"></i>ìƒˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì¶”ê°€</h5>
        <div id="newItemsContainer"></div>
        <button type="button" class="btn btn-outline-secondary" onclick="addNewItem()">
            <i class="bi bi-plus-circle me-2"></i>ìƒˆ í•­ëª© ì¶”ê°€
        </button>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-check-circle me-2"></i>ì €ì¥
        </button>
        <a href="/" class="btn btn-secondary btn-lg">
            <i class="bi bi-x-circle me-2"></i>ì·¨ì†Œ
        </a>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    function onScheduleTypeChange() {
        const typeSelect = document.getElementById('schedule_type');
        const detailWrapper = document.getElementById('schedule_detail_wrapper');
        const help = document.getElementById('scheduleDetailHelp');
        if (typeSelect.value === 'monthly') {
            detailWrapper.style.display = 'none';
            help.innerHTML = '<i class="bi bi-info-circle me-2"></i>ë§¤ì›” ì •ê¸°ì ìœ¼ë¡œ ìˆ˜í–‰ë©ë‹ˆë‹¤.';
        } else if (typeSelect.value === 'quarterly') {
            detailWrapper.style.display = 'block';
            help.innerHTML = '<i class="bi bi-info-circle me-2"></i>ì˜ˆ: 1,4,7,10 ë˜ëŠ” 3,6,9,12 ë“± ë¶„ê¸° ì‹œì‘ ì›”ì„ ì‰¼í‘œë¡œ ì…ë ¥í•˜ì„¸ìš”.';
        } else {
            detailWrapper.style.display = 'block';
            help.innerHTML = '<i class="bi bi-info-circle me-2"></i>ìˆ˜í–‰í•  ì›”ë“¤ì„ ì‰¼í‘œë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2,5,8,11).';
        }
    }
    
    document.addEventListener('DOMContentLoaded', onScheduleTypeChange);
    
    function addNewItem() {
        const container = document.getElementById('newItemsContainer');
        const div = document.createElement('div');
        div.className = 'p-3 mb-3';
        div.style.cssText = 'background: white; border-radius: 12px; border: 2px solid rgba(102, 126, 234, 0.1);';
        div.innerHTML = `
            <div class="mb-2">
                <label class="form-label fw-bold">ìƒˆ í•­ëª© ì„¤ëª…</label>
                <input type="text" class="form-control" name="new_item_description" placeholder="í•­ëª© ì„¤ëª…">
            </div>
            <div class="mb-0">
                <label class="form-label fw-bold">ì²¨ë¶€íŒŒì¼ (ì„ íƒ)</label>
                <input type="file" class="form-control" name="new_item_file">
            </div>
        `;
        container.appendChild(div);
    }
</script>
{% endblock %}