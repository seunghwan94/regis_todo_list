{% extends "base.html" %}

{% block title %}새 점검 추가 - 정기 점검 관리{% endblock %}

{% block content %}
<h1>새로운 정기 점검 추가</h1>
<form method="post" enctype="multipart/form-data" action="/task/new">
    <div class="mb-3">
        <label for="company_id" class="form-label">고객사 선택</label>
        <select class="form-select" id="company_id" name="company_id" required>
            <option value="" disabled selected>고객사를 선택하세요</option>
            {% for comp in companies %}
                <option value="{{ comp['id'] }}">{{ comp['name'] }}{% if comp['sub_name'] %} / {{ comp['sub_name'] }}{% endif %}</option>
            {% endfor %}
        </select>
        <div class="form-text"><a href="/company/new">새 고객사 추가</a></div>
    </div>
    <!-- Detail name (sub-customer) for this task -->
    <div class="mb-3">
        <label for="detail_name" class="form-label">상세 고객사</label>
        <input type="text" class="form-control" id="detail_name" name="detail_name" placeholder="예: 홈페이지 / 다이렉트 / mydata 등">
        <div class="form-text">정기점검이 진행되는 상세 영역을 입력하세요 (옵션).</div>
    </div>
    <div class="mb-3">
        <label class="form-label">점검 유형</label>
        <div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="task_type" id="type_in" value="INHOUSE" checked>
                <label class="form-check-label" for="type_in">사내점검</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="task_type" id="type_out" value="ONSITE">
                <label class="form-check-label" for="type_out">방문점검</label>
            </div>
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label">서명 방법</label>
        <div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="signature_method" id="sig_email" value="EMAIL" checked>
                <label class="form-check-label" for="sig_email">메일</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="signature_method" id="sig_visit" value="VISIT">
                <label class="form-check-label" for="sig_visit">방문</label>
            </div>
        </div>
    </div>

    <!-- Contact information -->
    <div class="mb-3">
        <label class="form-label">담당자 정보</label>
        <div class="row g-2">
            <div class="col-md-4">
                <input type="text" class="form-control" name="contact_name" placeholder="담당자 이름">
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" name="contact_phone" placeholder="전화번호">
            </div>
            <div class="col-md-4">
                <input type="email" class="form-control" name="contact_email" placeholder="이메일">
            </div>
        </div>
    </div>
    <div class="mb-3">
        <label for="schedule_type" class="form-label">스케줄 유형</label>
        <select class="form-select" id="schedule_type" name="schedule_type" required onchange="onScheduleTypeChange()">
            <option value="monthly" selected>매월</option>
            <option value="quarterly">분기</option>
            <option value="custom">기타 (사용자 지정)</option>
        </select>
        <div id="scheduleDetailHelp" class="form-text"></div>
    </div>
    <div class="mb-3" id="schedule_detail_wrapper" style="display: none;">
        <label for="schedule_detail" class="form-label">스케줄 상세 (쉼표로 구분된 월)</label>
        <input type="text" class="form-control" id="schedule_detail" name="schedule_detail" placeholder="예: 1,4,7,10">
        <div class="form-text">분기나 기타 유형일 경우 수행할 월들을 쉼표로 입력하세요.</div>
    </div>
    <hr>
    <h5>체크리스트 항목</h5>
    <p class="text-muted">각 항목에 대한 설명과 (선택 사항) 첨부파일을 업로드하세요. 빈 항목은 무시됩니다.</p>
    <div id="items-container">
        <div class="row g-2 mb-2 checklist-item">
            <div class="col-sm-8">
                <input type="text" class="form-control" name="item_description" placeholder="항목 설명" required>
            </div>
            <div class="col-sm-4">
                <input type="file" class="form-control" name="item_file">
            </div>
        </div>
    </div>
    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addChecklistItem()">항목 추가</button>
    <hr>
    <button type="submit" class="btn btn-primary">저장</button>
    <a href="/" class="btn btn-secondary">취소</a>
</form>

{% endblock %}

{% block scripts %}
<script>
    function onScheduleTypeChange() {
        const typeSelect = document.getElementById('schedule_type');
        const detailWrapper = document.getElementById('schedule_detail_wrapper');
        const help = document.getElementById('scheduleDetailHelp');
        if (typeSelect.value === 'monthly') {
            detailWrapper.style.display = 'none';
            help.textContent = '매월 정기적으로 수행됩니다.';
        } else if (typeSelect.value === 'quarterly') {
            detailWrapper.style.display = 'block';
            help.textContent = '예: 1,4,7,10 또는 3,6,9,12 등 분기 시작 월을 쉼표로 입력하세요.';
        } else {
            detailWrapper.style.display = 'block';
            help.textContent = '수행할 월들을 쉼표로 입력하세요 (예: 2,5,8,11).';
        }
    }
    function addChecklistItem() {
        const container = document.getElementById('items-container');
        const row = document.createElement('div');
        row.className = 'row g-2 mb-2 checklist-item';
        row.innerHTML = `
            <div class="col-sm-8">
                <input type="text" class="form-control" name="item_description" placeholder="항목 설명">
            </div>
            <div class="col-sm-4">
                <input type="file" class="form-control" name="item_file">
            </div>
        `;
        container.appendChild(row);
    }
    // Initialize help text
    document.addEventListener('DOMContentLoaded', onScheduleTypeChange);
</script>
{% endblock %}